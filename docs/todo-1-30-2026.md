# TODO - January 30, 2026

Code review findings for luis-ruiz.com portfolio site. Issues organized by severity.

---

## CRITICAL (Blocking Bugs)

### ~~1. Variable Shadowing Bug in LLM Chat Route~~ FIXED
**File:** `app/api/nucleus/llm/chat/route.ts:180`

~~The variable `response` is declared twice...~~

**Status:** Already fixed. Uses `httpResponse` for the NextResponse object.

---

### 2. Missing Database Table Migrations
**File:** `supabase/migrations/`

Only RLS policy migration exists (`20260125_120000_nucleus_rls.sql`). Missing CREATE TABLE migrations for:
- `nucleus_profiles`
- `nucleus_credit_transactions`
- `nucleus_usage_logs`
- `nucleus_model_pricing`
- `nucleus_credit_packages`
- `nucleus_subscription_plans`

The RLS migration references tables that don't exist yet. Nucleus Bot API will fail on all queries.

**Fix:** Create table migration files or document that tables must be created manually in Supabase Studio.

---

### 3. Stripe Publishable Key Env Var Mismatch
**Files:**
- `.env.example:50` defines `STRIPE_PUBLISHABLE_KEY`
- `lib/clients/stripe/client.ts:41` reads `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`

Developers following `.env.example` will set the wrong variable name. Client-side Stripe will fail.

**Fix:** Update `.env.example` to use `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`

---

## HIGH PRIORITY

### 4. Incomplete OAuth Callback Implementation
**File:** `app/nucleus/auth/callback/route.ts`

The callback route just redirects to success/error pages. Missing:
- Authorization code exchange for tokens
- Token storage
- PKCE flow handling
- Actual user authentication

Success/error UI pages exist but the actual OAuth flow is incomplete.

---

### ~~5. Missing Error Handler for Insufficient Credits~~ FIXED
**File:** `app/api/nucleus/llm/chat/route.ts`

**Status:** Already fixed. Credits are checked at lines 112-127 **before** the LLM call is made. Returns proper 402 with `INSUFFICIENT_CREDITS` code and details.

---

### 6. Hard-Coded Production Domain Fallback
**Files:**
- `app/api/nucleus/credits/purchase/route.ts:66`
- `app/api/nucleus/subscription/create/route.ts:78`

```typescript
const baseUrl = process.env.NEXT_PUBLIC_SITE_URL || 'https://luis-ruiz.com';
```

In dev/staging, missing env var causes Stripe redirects to production.

**Fix:** Require the env var or use `http://localhost:5000` as dev fallback.

---

## MEDIUM PRIORITY

### 7. Unused/Dead Code: `getUserIdFromRequest()`
**File:** `lib/nucleus/auth.ts:217-223`

Function is exported but never used. Implementation just returns `null`.

**Fix:** Remove or implement properly.

---

### 8. Potential Race Condition in Profile Creation
**File:** `lib/nucleus/credits.ts:22-60`

`getOrCreateProfile()` checks if profile exists, then creates if not. Between these operations another request could create the same profile causing unique constraint violation.

**Fix:** Use upsert or handle the constraint violation error.

---

### 9. Stripe API Version
**File:** `lib/clients/stripe/client.ts:21`

```typescript
apiVersion: '2025-02-24.acacia',
```

Verify this version exists and is stable. Future-dated versions could cause compatibility issues.

---

## LOW PRIORITY (Lint Warnings)

### 10. Unused Variables/Imports
Run `npm run lint` to see all. Key files:
- `app/api/nucleus/auth/session/route.ts` - unused `request` param
- `app/api/nucleus/credits/packages/route.ts` - unused `NextResponse`, `request`
- `app/api/nucleus/credits/purchase/route.ts` - unused `getProfile`
- `app/api/nucleus/llm/chat/route.ts` - unused `getModelInfo`
- `app/api/nucleus/webhooks/stripe/route.ts` - unused `packageId`
- `lib/nucleus/auth.ts` - unused `getProfile`, `request`

**Fix:** Remove unused imports/variables or prefix with `_` if intentionally unused.

---

### 11. TODO Comments in Code
- `components/app/landing_page/Hero.tsx:16` - Images from Supabase admin
- `components/app/gio_dashboard/SystemHealthCard.tsx:442` - System health checks
- `app/api/votes/route.ts:10` - Auth-derived email

---

## NICE TO HAVE

### 12. Documentation Gaps
- Create table schema documentation for Nucleus Bot tables
- Document the OAuth flow for external applications
- Add API documentation for Nucleus Bot endpoints

---

## Summary

| Severity | Count | Action Required |
|----------|-------|-----------------|
| CRITICAL | 2 | Fix before deploying |
| HIGH | 2 | Fix soon |
| MEDIUM | 3 | Plan to address |
| LOW | 2 | Clean up when convenient |

**Recommended order:**
1. Fix env var mismatch (#3) - quick fix
2. Create or document database migrations (#2)
3. Complete OAuth flow (#4) or document current limitations
